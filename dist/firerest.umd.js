var q=Object.defineProperty;var N=Object.getOwnPropertySymbols;var H=Object.prototype.hasOwnProperty,J=Object.prototype.propertyIsEnumerable;var P=(a,u,l)=>u in a?q(a,u,{enumerable:!0,configurable:!0,writable:!0,value:l}):a[u]=l,b=(a,u)=>{for(var l in u||(u={}))H.call(u,l)&&P(a,l,u[l]);if(N)for(var l of N(u))J.call(u,l)&&P(a,l,u[l]);return a};(function(a,u){typeof exports=="object"&&typeof module!="undefined"?module.exports=u():typeof define=="function"&&define.amd?define(u):(a=typeof globalThis!="undefined"?globalThis:a||self,a.firerest=u())})(this,function(){"use strict";var a={exports:{}},u=typeof Reflect=="object"?Reflect:null,l=u&&typeof u.apply=="function"?u.apply:function(e,t,r){return Function.prototype.apply.call(e,t,r)},y;u&&typeof u.ownKeys=="function"?y=u.ownKeys:Object.getOwnPropertySymbols?y=function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:y=function(e){return Object.getOwnPropertyNames(e)};function M(n){console&&console.warn&&console.warn(n)}var w=Number.isNaN||function(e){return e!==e};function f(){f.init.call(this)}a.exports=f,a.exports.once=I,f.EventEmitter=f,f.prototype._events=void 0,f.prototype._eventsCount=0,f.prototype._maxListeners=void 0;var E=10;function L(n){if(typeof n!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof n)}Object.defineProperty(f,"defaultMaxListeners",{enumerable:!0,get:function(){return E},set:function(n){if(typeof n!="number"||n<0||w(n))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+n+".");E=n}}),f.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},f.prototype.setMaxListeners=function(e){if(typeof e!="number"||e<0||w(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this};function O(n){return n._maxListeners===void 0?f.defaultMaxListeners:n._maxListeners}f.prototype.getMaxListeners=function(){return O(this)},f.prototype.emit=function(e){for(var t=[],r=1;r<arguments.length;r++)t.push(arguments[r]);var s=e==="error",o=this._events;if(o!==void 0)s=s&&o.error===void 0;else if(!s)return!1;if(s){var i;if(t.length>0&&(i=t[0]),i instanceof Error)throw i;var c=new Error("Unhandled error."+(i?" ("+i.message+")":""));throw c.context=i,c}var d=o[e];if(d===void 0)return!1;if(typeof d=="function")l(d,this,t);else for(var h=d.length,p=T(d,h),r=0;r<h;++r)l(p[r],this,t);return!0};function x(n,e,t,r){var s,o,i;if(L(t),o=n._events,o===void 0?(o=n._events=Object.create(null),n._eventsCount=0):(o.newListener!==void 0&&(n.emit("newListener",e,t.listener?t.listener:t),o=n._events),i=o[e]),i===void 0)i=o[e]=t,++n._eventsCount;else if(typeof i=="function"?i=o[e]=r?[t,i]:[i,t]:r?i.unshift(t):i.push(t),s=O(n),s>0&&i.length>s&&!i.warned){i.warned=!0;var c=new Error("Possible EventEmitter memory leak detected. "+i.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");c.name="MaxListenersExceededWarning",c.emitter=n,c.type=e,c.count=i.length,M(c)}return n}f.prototype.addListener=function(e,t){return x(this,e,t,!1)},f.prototype.on=f.prototype.addListener,f.prototype.prependListener=function(e,t){return x(this,e,t,!0)};function S(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function j(n,e,t){var r={fired:!1,wrapFn:void 0,target:n,type:e,listener:t},s=S.bind(r);return s.listener=t,r.wrapFn=s,s}f.prototype.once=function(e,t){return L(t),this.on(e,j(this,e,t)),this},f.prototype.prependOnceListener=function(e,t){return L(t),this.prependListener(e,j(this,e,t)),this},f.prototype.removeListener=function(e,t){var r,s,o,i,c;if(L(t),s=this._events,s===void 0)return this;if(r=s[e],r===void 0)return this;if(r===t||r.listener===t)--this._eventsCount==0?this._events=Object.create(null):(delete s[e],s.removeListener&&this.emit("removeListener",e,r.listener||t));else if(typeof r!="function"){for(o=-1,i=r.length-1;i>=0;i--)if(r[i]===t||r[i].listener===t){c=r[i].listener,o=i;break}if(o<0)return this;o===0?r.shift():U(r,o),r.length===1&&(s[e]=r[0]),s.removeListener!==void 0&&this.emit("removeListener",e,c||t)}return this},f.prototype.off=f.prototype.removeListener,f.prototype.removeAllListeners=function(e){var t,r,s;if(r=this._events,r===void 0)return this;if(r.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):r[e]!==void 0&&(--this._eventsCount==0?this._events=Object.create(null):delete r[e]),this;if(arguments.length===0){var o=Object.keys(r),i;for(s=0;s<o.length;++s)i=o[s],i!=="removeListener"&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(t=r[e],typeof t=="function")this.removeListener(e,t);else if(t!==void 0)for(s=t.length-1;s>=0;s--)this.removeListener(e,t[s]);return this};function R(n,e,t){var r=n._events;if(r===void 0)return[];var s=r[e];return s===void 0?[]:typeof s=="function"?t?[s.listener||s]:[s]:t?F(s):T(s,s.length)}f.prototype.listeners=function(e){return R(this,e,!0)},f.prototype.rawListeners=function(e){return R(this,e,!1)},f.listenerCount=function(n,e){return typeof n.listenerCount=="function"?n.listenerCount(e):C.call(n,e)},f.prototype.listenerCount=C;function C(n){var e=this._events;if(e!==void 0){var t=e[n];if(typeof t=="function")return 1;if(t!==void 0)return t.length}return 0}f.prototype.eventNames=function(){return this._eventsCount>0?y(this._events):[]};function T(n,e){for(var t=new Array(e),r=0;r<e;++r)t[r]=n[r];return t}function U(n,e){for(;e+1<n.length;e++)n[e]=n[e+1];n.pop()}function F(n){for(var e=new Array(n.length),t=0;t<e.length;++t)e[t]=n[t].listener||n[t];return e}function I(n,e){return new Promise(function(t,r){function s(i){n.removeListener(e,o),r(i)}function o(){typeof n.removeListener=="function"&&n.removeListener("error",s),t([].slice.call(arguments))}A(n,e,o,{once:!0}),e!=="error"&&K(n,s,{once:!0})})}function K(n,e,t){typeof n.on=="function"&&A(n,"error",e,t)}function A(n,e,t,r){if(typeof n.on=="function")r.once?n.once(e,t):n.on(e,t);else if(typeof n.addEventListener=="function")n.addEventListener(e,function s(o){r.once&&n.removeEventListener(e,s),t(o)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof n)}var W=a.exports;class $ extends W{constructor(){super()}emitAsync(e,...t){let r=[];return this.listeners(e).forEach(s=>{var o=s(...t);r.push(o)}),Promise.all(r)}}class _ extends ${constructor({parent:e,root:t,path:r,headers:s={}}){super();this._parent=e,this._root=t,this._path=r,this._headers=s}child(e){return new _({parent:this,root:this.isRoot()?this:this.root,headers:{},path:e.toString()})}async fetch({type:e,data:t={}}){let r=this.path;e=e.toUpperCase();try{await this.root.emitAsync("prefetch",{self:this,path:r,type:e})}catch(h){console.error("--- prefetch error ---",h)}let s=this.root,o=this.headers(),i="",c=null,d=s._fetch;if(e==="GET"||e==="DELETE"){let h=new URLSearchParams;Object.entries(t).forEach(([v,m])=>{Array.isArray(m)?(v=v+"[]",m.forEach(g=>{h.append(v,g)})):typeof m=="object"?Object.entries(m).forEach(([g,G])=>{h.append(`${v}[${g}]`,G)}):h.append(v,m)});let p=h.toString();p&&(i="?"+p)}else t.constructor!==globalThis.FormData?(o["Content-Type"]="application/json; charset=utf-8",c=JSON.stringify(t)):c=t;try{let h=await d(r+i,{method:e,headers:o,body:c}),p=await h.json();if(!h.ok)throw{res:h,result:p};return s._debug&&(console.groupCollapsed("## firerest: %s",r),console.log("payload:",t),console.log("response:",p),console.groupEnd()),await this.root.emitAsync("postfetch",{self:this,path:r,type:e,res:h,status:h.status,result:p}),p}catch(h){await this.root.emitAsync("fail",{self:this,path:r,type:e,res:h.res,status:h.res.status,result:h.result})}}get(e){return this.fetch({type:"GET",data:e})}post(e){return this.fetch({type:"POST",data:e})}put(e){return this.fetch({type:"PUT",data:e})}del(e){return this.fetch({type:"DELETE",data:e})}get root(){return this._root}get parent(){return this._parent}get path(){if(this.isRoot())return this._baseURL;let e=[],t=this;do t._path&&e.unshift(t._path);while(t=t.parent);let r=e.join("/");return this.root._baseURL+"/"+r}headers(...e){if(e.length===1){let r=typeof e[0];if(r==="string")return this._headers[e[0]];if(r==="object")return Object.assign(this._headers,e[0]),this}else if(e.length===2)return this._headers[e[0]]=e[1],this;let t=this.parent?this.parent.headers():{};return b(b({},t),this._headers)}isRoot(){return this.root===null}}class D extends _{constructor({baseURL:e,debug:t=!1,fetch:r=globalThis.fetch}){super({parent:null,root:null,headers:{},path:""});this._debug=t,this._baseURL=e.replace(/\/$/,""),this._fetch=r}setFetch(e){this._fetch=e}}return{create(n){return new D(n)}}});
