var X=Object.defineProperty;var z=Object.getOwnPropertySymbols;var Y=Object.prototype.hasOwnProperty,Z=Object.prototype.propertyIsEnumerable;var K=(d,v,m)=>v in d?X(d,v,{enumerable:!0,configurable:!0,writable:!0,value:m}):d[v]=m,R=(d,v)=>{for(var m in v||(v={}))Y.call(v,m)&&K(d,m,v[m]);if(z)for(var m of z(v))Z.call(v,m)&&K(d,m,v[m]);return d};(function(d,v){typeof exports=="object"&&typeof module!="undefined"?module.exports=v():typeof define=="function"&&define.amd?define(v):(d=typeof globalThis!="undefined"?globalThis:d||self,d.firerest=v())})(this,function(){"use strict";function d(n){if(typeof n!="string")throw new TypeError("Path must be a string. Received "+JSON.stringify(n))}function v(n,e){for(var t="",r=0,s=-1,o=0,i,f=0;f<=n.length;++f){if(f<n.length)i=n.charCodeAt(f);else{if(i===47)break;i=47}if(i===47){if(!(s===f-1||o===1))if(s!==f-1&&o===2){if(t.length<2||r!==2||t.charCodeAt(t.length-1)!==46||t.charCodeAt(t.length-2)!==46){if(t.length>2){var u=t.lastIndexOf("/");if(u!==t.length-1){u===-1?(t="",r=0):(t=t.slice(0,u),r=t.length-1-t.lastIndexOf("/")),s=f,o=0;continue}}else if(t.length===2||t.length===1){t="",r=0,s=f,o=0;continue}}e&&(t.length>0?t+="/..":t="..",r=2)}else t.length>0?t+="/"+n.slice(s+1,f):t=n.slice(s+1,f),r=f-s-1;s=f,o=0}else i===46&&o!==-1?++o:o=-1}return t}function m(n,e){var t=e.dir||e.root,r=e.base||(e.name||"")+(e.ext||"");return t?t===e.root?t+r:t+n+r:r}var L={resolve:function(){for(var e="",t=!1,r,s=arguments.length-1;s>=-1&&!t;s--){var o;s>=0?o=arguments[s]:(r===void 0&&(r=process.cwd()),o=r),d(o),o.length!==0&&(e=o+"/"+e,t=o.charCodeAt(0)===47)}return e=v(e,!t),t?e.length>0?"/"+e:"/":e.length>0?e:"."},normalize:function(e){if(d(e),e.length===0)return".";var t=e.charCodeAt(0)===47,r=e.charCodeAt(e.length-1)===47;return e=v(e,!t),e.length===0&&!t&&(e="."),e.length>0&&r&&(e+="/"),t?"/"+e:e},isAbsolute:function(e){return d(e),e.length>0&&e.charCodeAt(0)===47},join:function(){if(arguments.length===0)return".";for(var e,t=0;t<arguments.length;++t){var r=arguments[t];d(r),r.length>0&&(e===void 0?e=r:e+="/"+r)}return e===void 0?".":L.normalize(e)},relative:function(e,t){if(d(e),d(t),e===t||(e=L.resolve(e),t=L.resolve(t),e===t))return"";for(var r=1;r<e.length&&e.charCodeAt(r)===47;++r);for(var s=e.length,o=s-r,i=1;i<t.length&&t.charCodeAt(i)===47;++i);for(var f=t.length,u=f-i,p=o<u?o:u,l=-1,c=0;c<=p;++c){if(c===p){if(u>p){if(t.charCodeAt(i+c)===47)return t.slice(i+c+1);if(c===0)return t.slice(i+c)}else o>p&&(e.charCodeAt(r+c)===47?l=c:c===0&&(l=0));break}var h=e.charCodeAt(r+c),y=t.charCodeAt(i+c);if(h!==y)break;h===47&&(l=c)}var g="";for(c=r+l+1;c<=s;++c)(c===s||e.charCodeAt(c)===47)&&(g.length===0?g+="..":g+="/..");return g.length>0?g+t.slice(i+l):(i+=l,t.charCodeAt(i)===47&&++i,t.slice(i))},_makeLong:function(e){return e},dirname:function(e){if(d(e),e.length===0)return".";for(var t=e.charCodeAt(0),r=t===47,s=-1,o=!0,i=e.length-1;i>=1;--i)if(t=e.charCodeAt(i),t===47){if(!o){s=i;break}}else o=!1;return s===-1?r?"/":".":r&&s===1?"//":e.slice(0,s)},basename:function(e,t){if(t!==void 0&&typeof t!="string")throw new TypeError('"ext" argument must be a string');d(e);var r=0,s=-1,o=!0,i;if(t!==void 0&&t.length>0&&t.length<=e.length){if(t.length===e.length&&t===e)return"";var f=t.length-1,u=-1;for(i=e.length-1;i>=0;--i){var p=e.charCodeAt(i);if(p===47){if(!o){r=i+1;break}}else u===-1&&(o=!1,u=i+1),f>=0&&(p===t.charCodeAt(f)?--f==-1&&(s=i):(f=-1,s=u))}return r===s?s=u:s===-1&&(s=e.length),e.slice(r,s)}else{for(i=e.length-1;i>=0;--i)if(e.charCodeAt(i)===47){if(!o){r=i+1;break}}else s===-1&&(o=!1,s=i+1);return s===-1?"":e.slice(r,s)}},extname:function(e){d(e);for(var t=-1,r=0,s=-1,o=!0,i=0,f=e.length-1;f>=0;--f){var u=e.charCodeAt(f);if(u===47){if(!o){r=f+1;break}continue}s===-1&&(o=!1,s=f+1),u===46?t===-1?t=f:i!==1&&(i=1):t!==-1&&(i=-1)}return t===-1||s===-1||i===0||i===1&&t===s-1&&t===r+1?"":e.slice(t,s)},format:function(e){if(e===null||typeof e!="object")throw new TypeError('The "pathObject" argument must be of type Object. Received type '+typeof e);return m("/",e)},parse:function(e){d(e);var t={root:"",dir:"",base:"",ext:"",name:""};if(e.length===0)return t;var r=e.charCodeAt(0),s=r===47,o;s?(t.root="/",o=1):o=0;for(var i=-1,f=0,u=-1,p=!0,l=e.length-1,c=0;l>=o;--l){if(r=e.charCodeAt(l),r===47){if(!p){f=l+1;break}continue}u===-1&&(p=!1,u=l+1),r===46?i===-1?i=l:c!==1&&(c=1):i!==-1&&(c=-1)}return i===-1||u===-1||c===0||c===1&&i===u-1&&i===f+1?u!==-1&&(f===0&&s?t.base=t.name=e.slice(1,u):t.base=t.name=e.slice(f,u)):(f===0&&s?(t.name=e.slice(1,i),t.base=e.slice(1,u)):(t.name=e.slice(f,i),t.base=e.slice(f,u)),t.ext=e.slice(i,u)),f>0?t.dir=e.slice(0,f-1):s&&(t.dir="/"),t},sep:"/",delimiter:":",win32:null,posix:null};L.posix=L;var x=L,A={exports:{}},b=typeof Reflect=="object"?Reflect:null,T=b&&typeof b.apply=="function"?b.apply:function(e,t,r){return Function.prototype.apply.call(e,t,r)},_;b&&typeof b.ownKeys=="function"?_=b.ownKeys:Object.getOwnPropertySymbols?_=function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:_=function(e){return Object.getOwnPropertyNames(e)};function W(n){console&&console.warn&&console.warn(n)}var j=Number.isNaN||function(e){return e!==e};function a(){a.init.call(this)}A.exports=a,A.exports.once=J,a.EventEmitter=a,a.prototype._events=void 0,a.prototype._eventsCount=0,a.prototype._maxListeners=void 0;var P=10;function E(n){if(typeof n!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof n)}Object.defineProperty(a,"defaultMaxListeners",{enumerable:!0,get:function(){return P},set:function(n){if(typeof n!="number"||n<0||j(n))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+n+".");P=n}}),a.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},a.prototype.setMaxListeners=function(e){if(typeof e!="number"||e<0||j(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this};function N(n){return n._maxListeners===void 0?a.defaultMaxListeners:n._maxListeners}a.prototype.getMaxListeners=function(){return N(this)},a.prototype.emit=function(e){for(var t=[],r=1;r<arguments.length;r++)t.push(arguments[r]);var s=e==="error",o=this._events;if(o!==void 0)s=s&&o.error===void 0;else if(!s)return!1;if(s){var i;if(t.length>0&&(i=t[0]),i instanceof Error)throw i;var f=new Error("Unhandled error."+(i?" ("+i.message+")":""));throw f.context=i,f}var u=o[e];if(u===void 0)return!1;if(typeof u=="function")T(u,this,t);else for(var p=u.length,l=U(u,p),r=0;r<p;++r)T(l[r],this,t);return!0};function S(n,e,t,r){var s,o,i;if(E(t),o=n._events,o===void 0?(o=n._events=Object.create(null),n._eventsCount=0):(o.newListener!==void 0&&(n.emit("newListener",e,t.listener?t.listener:t),o=n._events),i=o[e]),i===void 0)i=o[e]=t,++n._eventsCount;else if(typeof i=="function"?i=o[e]=r?[t,i]:[i,t]:r?i.unshift(t):i.push(t),s=N(n),s>0&&i.length>s&&!i.warned){i.warned=!0;var f=new Error("Possible EventEmitter memory leak detected. "+i.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");f.name="MaxListenersExceededWarning",f.emitter=n,f.type=e,f.count=i.length,W(f)}return n}a.prototype.addListener=function(e,t){return S(this,e,t,!1)},a.prototype.on=a.prototype.addListener,a.prototype.prependListener=function(e,t){return S(this,e,t,!0)};function $(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function k(n,e,t){var r={fired:!1,wrapFn:void 0,target:n,type:e,listener:t},s=$.bind(r);return s.listener=t,r.wrapFn=s,s}a.prototype.once=function(e,t){return E(t),this.on(e,k(this,e,t)),this},a.prototype.prependOnceListener=function(e,t){return E(t),this.prependListener(e,k(this,e,t)),this},a.prototype.removeListener=function(e,t){var r,s,o,i,f;if(E(t),s=this._events,s===void 0)return this;if(r=s[e],r===void 0)return this;if(r===t||r.listener===t)--this._eventsCount==0?this._events=Object.create(null):(delete s[e],s.removeListener&&this.emit("removeListener",e,r.listener||t));else if(typeof r!="function"){for(o=-1,i=r.length-1;i>=0;i--)if(r[i]===t||r[i].listener===t){f=r[i].listener,o=i;break}if(o<0)return this;o===0?r.shift():G(r,o),r.length===1&&(s[e]=r[0]),s.removeListener!==void 0&&this.emit("removeListener",e,f||t)}return this},a.prototype.off=a.prototype.removeListener,a.prototype.removeAllListeners=function(e){var t,r,s;if(r=this._events,r===void 0)return this;if(r.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):r[e]!==void 0&&(--this._eventsCount==0?this._events=Object.create(null):delete r[e]),this;if(arguments.length===0){var o=Object.keys(r),i;for(s=0;s<o.length;++s)i=o[s],i!=="removeListener"&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(t=r[e],typeof t=="function")this.removeListener(e,t);else if(t!==void 0)for(s=t.length-1;s>=0;s--)this.removeListener(e,t[s]);return this};function M(n,e,t){var r=n._events;if(r===void 0)return[];var s=r[e];return s===void 0?[]:typeof s=="function"?t?[s.listener||s]:[s]:t?I(s):U(s,s.length)}a.prototype.listeners=function(e){return M(this,e,!0)},a.prototype.rawListeners=function(e){return M(this,e,!1)},a.listenerCount=function(n,e){return typeof n.listenerCount=="function"?n.listenerCount(e):F.call(n,e)},a.prototype.listenerCount=F;function F(n){var e=this._events;if(e!==void 0){var t=e[n];if(typeof t=="function")return 1;if(t!==void 0)return t.length}return 0}a.prototype.eventNames=function(){return this._eventsCount>0?_(this._events):[]};function U(n,e){for(var t=new Array(e),r=0;r<e;++r)t[r]=n[r];return t}function G(n,e){for(;e+1<n.length;e++)n[e]=n[e+1];n.pop()}function I(n){for(var e=new Array(n.length),t=0;t<e.length;++t)e[t]=n[t].listener||n[t];return e}function J(n,e){return new Promise(function(t,r){function s(i){n.removeListener(e,o),r(i)}function o(){typeof n.removeListener=="function"&&n.removeListener("error",s),t([].slice.call(arguments))}D(n,e,o,{once:!0}),e!=="error"&&q(n,s,{once:!0})})}function q(n,e,t){typeof n.on=="function"&&D(n,"error",e,t)}function D(n,e,t,r){if(typeof n.on=="function")r.once?n.once(e,t):n.on(e,t);else if(typeof n.addEventListener=="function")n.addEventListener(e,function s(o){r.once&&n.removeEventListener(e,s),t(o)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof n)}var B=A.exports;class H extends B{constructor(){super()}emitAsync(e,...t){let r=[];return this.listeners(e).forEach(s=>{var o=s(...t);r.push(o)}),Promise.all(r)}}class C extends H{constructor({parent:e,root:t,path:r,headers:s={}}){super();this._parent=e,this._root=t,this._path=r,this._headers=s}child(e){return new C({parent:this,root:this.isRoot()?this:this.root,headers:{},path:e.toString()})}async fetch({type:e,data:t={}}){var c;let r=this.root,s=this.path,o=r._baseURL+"/"+s;e=e.toUpperCase();try{await this.root.emitAsync("prefetch",{self:this,path:s,endpoint:o,type:e})}catch(h){console.error("--- prefetch error ---",h)}let i=this.headers(),f="",u=null,p=r._fetch;if(e==="GET"||e==="DELETE"){let h=new URLSearchParams;Object.entries(t).forEach(([g,w])=>{Array.isArray(w)?(g=g+"[]",w.forEach(O=>{h.append(g,O)})):typeof w=="object"?Object.entries(w).forEach(([O,V])=>{h.append(`${g}[${O}]`,V)}):h.append(g,w)});let y=h.toString();y&&(f="?"+y)}else t.constructor!==globalThis.FormData?(i["Content-Type"]="application/json; charset=utf-8",u=JSON.stringify(t)):u=t;let l;try{l=await p(o+f,{method:e,headers:i,body:u});let h;try{h=await l.json()}catch(y){let g=new Error(l.statusText||l.status);throw g.res=l,g.nativeError=y,g.status=l.status,g}if(!l.ok){let y=new Error(h.message);throw y.status=l.status,y.res=l,y.result=h,y}return r._debug&&(console.groupCollapsed("## firerest: %s",o),console.log("payload:",t),console.log("response:",h),console.groupEnd()),await this.root.emitAsync("postfetch",{self:this,path:s,endpoint:o,type:e,res:l,status:l.status,result:h}),h}catch(h){throw l||(h=Object.assign(new Error(this._root.getNetworkErrorMessage()),{nativeError:h,isNetworkError:!0})),await this.root.emitAsync("fail",{self:this,path:s,endpoint:o,type:e,res:h.res,status:(c=h.res)==null?void 0:c.status,result:h.result,message:h.message}),h}}get(e){return this.fetch({type:"GET",data:e})}post(e){return this.fetch({type:"POST",data:e})}put(e){return this.fetch({type:"PUT",data:e})}del(e){return this.fetch({type:"DELETE",data:e})}get root(){return this._root}get parent(){return this._parent}get path(){if(this.isRoot())return this._baseURL;let e=[],t=this;do t._path&&e.unshift(t._path);while(t=t.parent);let r=x.join(...e);return x.normalize(r)}headers(...e){if(e.length===1){let r=typeof e[0];if(r==="string")return this._headers[e[0]];if(r==="object")return Object.assign(this._headers,e[0]),this}else if(e.length===2)return this._headers[e[0]]=e[1],this;let t=this.parent?this.parent.headers():{};return R(R({},t),this._headers)}isRoot(){return this.root===null}}class Q extends C{constructor({baseURL:e,debug:t=!1,fetch:r=globalThis.fetch}){super({parent:null,root:null,headers:{},path:""});this._debug=t,this._baseURL=e.replace(/\/$/,""),this._fetch=r}setFetch(e){this._fetch=e}setNetworkErrorMessage(e){this._networkErrorMessage=e}getNetworkErrorMessage(){return this._networkErrorMessage||"Failed to fetch"}}return{create(n){return new Q(n)}}});
